// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String    @id @default(uuid())
  email                String    @unique
  password             String
  name                 String
  role                 Role      @default(CLIENT)
  google_refresh_token String?

  // Relation for Employees to the Business they work for
  businessId String?
  business   Business? @relation("BusinessEmployees", fields: [businessId], references: [id])

  // Relation for Business owners
  ownedBusiness Business? @relation("Owner")

  // Relations for Employees
  workSchedules      WorkSchedule[]
  employeeServices   EmployeeService[]
  bookingsAsEmployee Booking[]         @relation("EmployeeBookings")

  // Relations for Customers
  bookingsAsCustomer Booking[] @relation("CustomerBookings")

  createdAt DateTime @default(now())
}

model Business {
  id      String @id @default(uuid())
  name        String
  slug        String? @unique
  address     String?
  description String?

  // Relation to Owner
  ownerId String @unique
  owner   User   @relation("Owner", fields: [ownerId], references: [id])

  // Relation to Employees
  employees User[] @relation("BusinessEmployees")

  // Company services and bookings
  services Service[]
  bookings Booking[]

  createdAt DateTime @default(now())
}

model Service {
  id          String  @id @default(uuid())
  name        String
  description String?
  duration    Int // duration in minutes
  price       Float

  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  employees EmployeeService[]
  bookings  Booking[]
}

// Join Table for Employee <-> Service
model EmployeeService {
  employeeId String
  employee   User   @relation(fields: [employeeId], references: [id])
  serviceId  String
  service    Service @relation(fields: [serviceId], references: [id])

  @@id([employeeId, serviceId])
}

model Booking {
  id        String   @id @default(uuid())
  startTime DateTime
  endTime   DateTime

  // Relation to Customer (optional)
  customerId String?
  customer   User?   @relation("CustomerBookings", fields: [customerId], references: [id])

  // Guest customer details
  customerName  String?
  customerEmail String?
  customerPhone String?

  // Relation to Business
  businessId String
  business   Business @relation(fields: [businessId], references: [id])

  // Relation to Employee
  employeeId String
  employee   User   @relation("EmployeeBookings", fields: [employeeId], references: [id])

  // Relation to Service
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  createdAt DateTime @default(now())
}

model WorkSchedule {
  id          String @id @default(uuid())
  dayOfWeek   Int // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime   String // "HH:mm" format
  endTime     String // "HH:mm" format

  employeeId String
  employee   User   @relation(fields: [employeeId], references: [id])
}

enum Role {
  OWNER
  CLIENT
  EMPLOYEE
}